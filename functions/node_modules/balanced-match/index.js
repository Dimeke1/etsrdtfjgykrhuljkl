// functions/index.js
const functions = require("firebase-functions");
const admin = require("firebase-admin");

admin.initializeApp();

const { GoogleGenerativeAI } = require("@google/generative-ai");

// Получаем ключ из конфигурации
const GEMINI_API_KEY = functions.config().gemini.key;
if (!GEMINI_API_KEY) {
  console.error("❌ Gemini API key не установлен!");
  throw new Error("Gemini API key missing");
}

const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);

exports.analyzeMessage = functions.https.onRequest(async (req, res) => {
  // CORS — разрешаем запросы с вашего сайта
  res.set("Access-Control-Allow-Origin", "*");
  res.set("Access-Control-Allow-Methods", "POST, OPTIONS");
  res.set("Access-Control-Allow-Headers", "Content-Type");

  if (req.method === "OPTIONS") return res.status(204).send("");
  if (req.method !== "POST") return res.status(405).json({ error: "Only POST allowed" });

  const { text, lang } = req.body;

  if (!text || typeof text !== "string") {
    return res.status(400).json({ error: "Field 'text' is required" });
  }

  try {
    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

    const prompt = `
You are a helpful, supportive, and calm AI security assistant named "AI Detect".
Analyze the following message: «${text}»
Language: ${lang === 'kk' ? 'Kazakh' : 'Russian'}.
Return ONLY a valid JSON object:
{
  "risk": "low" | "medium" | "high",
  "message": "A natural, friendly response explaining risk or safety. Give 1-2 actionable tips. Be empathetic."
}
    `.trim();

    const result = await model.generateContent(prompt);
    const responseText = result.response.text();

    // Убираем markdown-блоки
    const clean = responseText.replace(/```json|```/g, "").trim();
    const parsed = JSON.parse(clean);

    return res.json(parsed);
  } catch (error) {
    console.error("Error:", error);
    return res.status(500).json({ error: "AI analysis failed" });
  }
});